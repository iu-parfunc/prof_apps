
# These are written from the perspective of one of the per-variant
# subdirs of this directory.

.PHONY: default clean run

ifeq ($(THREADS),)
  THREADS=8
endif

ifeq ($(DYNAPROF_ROOT),)
  DYNAPROF_ROOT=$(shell pwd)/../../../
endif

default: build

build-plain:
	$(MAKE) build-shared

# Build with icc and profiling enabled:
build-prof:
	echo -e "Building RAxML with gprof enabled..."
	$(MAKE) MORECFLAGS='-pg' build-shared

DPLIBS = $(DYNAPROF_ROOT)/dynaprof/build/libdynaprof.a \
         $(DYNAPROF_ROOT)/zcatoggle/build/libzca-toggle.a

build-dynaprof: build-dynaprof1 build-dynaprof2
build-dynaprof1:
	echo -e "\n Setting up and instrumenting RAxML..."
	(cd $(DYNAPROF_ROOT) && make lib)
	make clean
	rm -rf ../instrumented && cp -R ../original ../instrumented
	(cd .. && ./instrument.sh)
build-dynaprof2:
	echo -e "\nBuilding instrumented RAxML..."
	(cd ../instrumented && time make -j MORELIBS="-lelf -lrt $(DPLIBS) " MORECFLAGS="-DDYNAPROF")
	echo -e "\nDone building RAxML with dynaprof linked."

build-shared:
	rm -rf ../instrumented
	cp -R ../original ../instrumented
	echo -e "\nBuilding RAxML..."
	(cd ../instrumented; time make -j)

run-common: 
	echo -e "\nRunning RAxML..."
	rm -f ../instrumented/*.foo
#	cd ../instrumented/ && \
         ./raxmlHPC  -s ../data/10.phylip -m GTRGAMMA -n foo -p 9829265386

	cd ../instrumented/ && \
         ./raxmlHPC-PTHREADS -T$(THREADS) -s ../data/10.phylip -m GTRGAMMA -n foo -p 9829265386


#         ./raxmlHPC-PTHREADS -T$(THREADS) -s ../data/10.phylip -m GTRCAT -n foo -p 9829265386

#	./original/raxmlHPC-PTHREADS -T10 -s prefix_align.phylip -m GTRCAT -n foo -p 9829265386
# ./original/raxmlHPC-PTHREADS -T10 -s alignment_for_ryan.phylip -m GTRCAT -n foo -p 9829265386

clean:
	rm -rf ../instrumented/; mkdir ../instrumented
#	(cd ../instrumented; $(MAKEIT) clean)
