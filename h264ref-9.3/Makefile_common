
# These are written from the perspective of one of the per-variant
# subdirs of this directory.

include ../../Makefile_globals

.PHONY: default clean run

default: 
	echo "Doing nothing during 'compile' phase... procrastinating until run."

#Build with ubiprof finstrument baeckend
build-ubiprof:
	  cd ..;./setup.sh 
		cd ../instrumented; make clean;\
		  make CFLAGS=$(UBIPROF_CFLAGS) LDFLAGS=$(UBIPROF_LD)

build-noprof:
	  cd ..;./setup.sh 
		cd ../instrumented; make clean;\
		  make CFLAGS='$(NOPROF_CFLAGS) LDFLAGS=$(NOPROD_LD)


#Build with finstrument
# THIS IS ODD 
# build-finstrument:
# 	cd ..;./setup.sh finstrument
# 	cd ../instrumented;\
# 		make clean;\
# 		make CFLAGS='-O2 -finstrument-functions -fno-optimize-sibling-calls' LDFLAGS='-L../../../build -lubiprof'
# build-dynaprof:
# 	cd ..; ./setup.sh dynaprof 
# 	echo -e "\nInstrumenting h264..."
# 	cd ..; ./instrument.sh
# 	echo -e "\nBuilding gzip with instrumentation...";
# 	cd ../instrumented;\
# 		make clean;\
# 		make CLFAGS='$(OPTLEVEL)' LDFLAGS='libdynaprof.a libzca-toggle.a -lrt -lelf -lpthread' 




# Build with icc and profiling:

build-prof:
	echo -e "Building gzip with gprof enabled..."
	$(MAKE) CFLAGS='$(OPTLEVEL) -pg' build-shared


build-plain:
	# $(MAKE) CFLAGS='$(OPTLEVEL)' build-shared
	(cd ..; ./setup.sh)
	(cd ../instrumented && make clean)
	(cd ../instrumented && time make CFLAGS="$(OPTLEVEL)" LDFLAGS='-lm')


build-shared:
	(cd ..; ./setup.sh)
	(cd ../instrumented && make clean)
	(cd ../instrumented && time make CFLAGS="$(CFLAGS)" LDFLAGS='-lm')

run-common: 
	(cd ../instrumented; LD_LIBRARY_PATH=../../../build/lib:$(LD_LIBRARY_PATH) $(TIME) ./h264ref -d test/input/foreman_test_encoder_baseline.cfg) 2>&1
	(cd ../instrumented; $(HSB_OUT))

run-noprof: 
	(cd ../instrumented; LD_LIBRARY_PATH=../../../build/noprof/:$(LD_LIBRARY_PATH) $(TIME) ./h264ref -d test/input/foreman_test_encoder_baseline.cfg) 2>&1
	(cd ../instrumented; $(HSB_OUT)) 

# run-common: 
# 	(cd ../instrumented; LD_LIBRARY_PATH=../../../build/:$(LD_LIBRARY_PATH) /usr/bin/time -f "SELFTIMED %e\nuser %U\nsys %S\n" ./h264ref -d test/input/foreman_test_encoder_baseline.cfg) 2>&1

# run-noprof: 
# 	(cd ../instrumented; LD_LIBRARY_PATH=../../../build/noprof/:$(LD_LIBRARY_PATH) /usr/bin/time -f "SELFTIMED %e\nuser %U\nsys %S\n" ./h264ref -d test/input/foreman_test_encoder_baseline.cfg) 2>&1





#	(cd ../instrumented && ./h264ref -d test/input/foreman_test_encoder_baseline.cfg)

# We don't really need to clean, because we do a fresh "configure" on each build.
clean:
