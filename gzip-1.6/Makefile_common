
# These are written from the perspective of one of the per-variant
# subdirs of this directory.

.PHONY: default clean run

default: 
	echo "Doing nothing during 'compile' phase... procrastinating until run."

# Build with icc and profiling:
build-prof:
	echo -e "Building gzip with gprof enabled..."
	$(MAKE) CFLAGS='-O2 -pg' build-shared

build-dynaprof:
	cd ..; ./setup.sh dynaprof 
# Buddhika says this extra autoreconf is necessary [2014.07.30]: 
	(cd ../instrumented &&  autoreconf) 
	(cd ../instrumented &&  ./configure CC=icc LIBS='libdynaprof.a libzca-toggle.a -lelf' CLFAGS='-O2';) > /dev/null
	(cd ../instrumented &&  make -j) > /dev/null
	echo -e "\nInstrumenting gzip..."
	(cd .. && ./instrument.sh)
	echo -e "\nBuilding gzip with instrumentation..."
	(cd ../instrumented && make clean && make)

build-plain:
	$(MAKE) CFLAGS='-O2' build-shared

build-shared:
#	chmod u+x setup.sh
	cd ..; ./setup.sh
	(cd ../instrumented &&  autoreconf)
	(cd ../instrumented &&  time ./configure CC=icc CFLAGS="$(CFLAGS)") > /dev/null
	(cd ../instrumented &&  time make) > /dev/null

run-common: 
	cd ../instrumented && \
		(/usr/bin/time -f "SELFTIMED %e\nuser %U\nsys %S\n" ./gzip -c ../../resources/a > a.gz) 2>&1 

# We don't really need to clean, because we do a fresh "configure" on each build.
clean:
