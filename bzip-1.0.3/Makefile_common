
# These are written from the perspective of one of the per-variant
# subdirs of this directory.

include ../../Makefile_globals

.PHONY: default clean run

ifeq ($(OPTLEVEL),)
    OPTLEVEL=-O2
endif

default: 
	echo "Doing nothing during 'compile' phase... procrastinating until run."

#Build with ubiprof finstrument baeckend
build-ubiprof:
	cd ..;./setup.sh finstrument
	cd ../instrumented; make clean;\
	make CFLAGS=$(UBIPROF_CFLAGS) LDFLAGS=$(UBIPROF_LD)

build-noprof:
	cd ..;./setup.sh finstrument
	cd ../instrumented; make clean;\
	make CFLAGS=$(NOPROF_CFLAGS) LDFLAGS=$(NOPROF_LD)

# Build with icc and profiling:
build-prof:
	echo -e "Building bzip2 with gprof enabled..."
	$(MAKE) CFLAGS='-O2 -pg' build-shared

build-dynaprof:
	cd ..; ./setup.sh dynaprof 
	echo -e "\nInstrumenting bzip2..."
	cd ..; ./instrument.sh
	echo -e "\nBuilding bzip2 with instrumentation...";
	cd ../instrumented;\
		make clean;\
		make CLFAGS='-O2' LDFLAGS='libdynaprof.a libzca-toggle.a -lrt -lelf -lpthread' 

build-plain:
	$(MAKE) CFLAGS='$(OPTLEVEL)' build-shared

build-shared:
	cd ..; ./setup.sh
	cd ../instrumented;\
		time make CFLAGS="$(CFLAGS)"

run-common: 
	(cd ../instrumented; LD_LIBRARY_PATH=../../../build/:$(LD_LIBRARY_PATH) $(TIME) ./bzip2 test/input/input.source) 2>&1 
	(cd ../instrumented; $(HSB_OUT))

run-noprof: 
	(cd ../instrumented; LD_LIBRARY_PATH=../../../build/noprof/:$(LD_LIBRARY_PATH) $(TIME) ./bzip2 test/input/input.source) 2>&1 
	(cd ../instrumented; $(HSB_OUT)) 

# run-common: 
# 	(cd ../instrumented; LD_LIBRARY_PATH=../../../build/:$(LD_LIBRARY_PATH) /usr/bin/time -f "SELFTIMED %e\nuser %U\nsys %S\n" ./bzip2 test/input/input.source) 2>&1 

# run-noprof: 
# 	(cd ../instrumented; LD_LIBRARY_PATH=../../../build/noprof/:$(LD_LIBRARY_PATH) /usr/bin/time -f "SELFTIMED %e\nuser %U\nsys %S\n" ./bzip2 test/input/input.source) 2>&1 

# We don't really need to clean, because we do a fresh "configure" on each build.
clean:
